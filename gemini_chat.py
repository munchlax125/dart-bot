"""
Gemini AI ì±—ë´‡ ëª¨ë“ˆ
- ì‚¬ì—… ë¶„ì„
- ì¬ë¬´ ë¶„ì„
- ê°ì‚¬ ìœ ì˜ì‚¬í•­ ë¶„ì„
- ëŒ€í™”í˜• ì±—ë´‡
"""

import google.generativeai as genai
from typing import Dict
import json


class GeminiAnalyzer:
    """Gemini AI ê¸°ë°˜ ì¬ë¬´ ë¶„ì„ê¸°"""
    
    def __init__(self, api_key: str):
        genai.configure(api_key=api_key)
        self.model = genai.GenerativeModel('gemini-1.5-pro')
    
    def business_analysis(self, company_name: str, financial_data: Dict) -> str:
        """ì‚¬ì—…ë¶„ì„ - íšŒì‚¬ê°€ ì–´ë–¤ ì‚¬ì—…ì„ í•˜ëŠ”ì§€ ë¶„ì„"""
        prompt = self._build_business_analysis_prompt(company_name, financial_data)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ì‚¬ì—…ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def financial_analysis(self, company_name: str, financial_data: Dict) -> str:
        """ì¬ë¬´ë¶„ì„ - ì¬ë¬´ì§€í‘œì™€ ê°•ì , ì•½ì  ë“± ë¶„ì„"""
        prompt = self._build_financial_analysis_prompt(company_name, financial_data)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ì¬ë¬´ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def audit_points_analysis(self, company_name: str, financial_data: Dict) -> str:
        """íšŒê³„ê°ì‚¬ ìœ ì˜ì‚¬í•­ ë¶„ì„"""
        prompt = self._build_audit_prompt(company_name, financial_data)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ê°ì‚¬ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def chat_response(self, company_name: str, financial_data: Dict, user_question: str) -> str:
        """ëŒ€í™”í˜• ì±—ë´‡ ì‘ë‹µ"""
        prompt = self._build_chat_prompt(company_name, financial_data, user_question)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def _build_business_analysis_prompt(self, company_name: str, financial_data: Dict) -> str:
        """ì‚¬ì—…ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return f"""
        ë‹¤ìŒì€ {company_name}ì˜ ì¬ë¬´ì œí‘œ ë°ì´í„°ì…ë‹ˆë‹¤:
        
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‚¬ì—…ë¶„ì„ì„ í•´ì£¼ì„¸ìš”:

        ## ğŸ¢ {company_name} ì‚¬ì—…ë¶„ì„ ë¦¬í¬íŠ¸

        ### 1. ì£¼ìš” ì‚¬ì—…ì˜ì—­
        **í•µì‹¬ ì‚¬ì—…**: ë§¤ì¶œ êµ¬ì„±ê³¼ ê³„ì •ê³¼ëª©ì„ í†µí•´ íŒŒì•…í•œ ì£¼ìš” ì‚¬ì—…
        **ì‚¬ì—… íŠ¹ì„±**: ì œì¡°ì—…/ì„œë¹„ìŠ¤ì—…/ê¸ˆìœµì—… ë“± ì—…ì¢… íŠ¹ì„±
        **ì‹œì¥ ìœ„ì¹˜**: í•´ë‹¹ ì—…ê³„ì—ì„œì˜ ì˜ˆìƒ í¬ì§€ì…˜

        ### 2. ë§¤ì¶œ êµ¬ì¡° ë¶„ì„
        **ë§¤ì¶œ ê·œëª¨**: ì—°ê°„ ë§¤ì¶œì•¡ê³¼ ì „ë…„ ëŒ€ë¹„ ë³€í™”
        **ìˆ˜ìµì„±**: ë§¤ì¶œì´ì´ìµë¥ ê³¼ ì˜ì—…ì´ìµë¥  ë¶„ì„
        **ì„±ì¥ì„±**: ë§¤ì¶œ ì„±ì¥ íŠ¸ë Œë“œì™€ íŒ¨í„´

        ### 3. ë¹„ìš© êµ¬ì¡° íŠ¹ì„±
        **ì£¼ìš” ë¹„ìš©**: ë§¤ì¶œì›ê°€, íŒê´€ë¹„ êµ¬ì„± ë¶„ì„
        **ë¹„ìš© íš¨ìœ¨ì„±**: ë¹„ìš© ëŒ€ë¹„ ë§¤ì¶œ íš¨ìœ¨ì„±
        **ê³ ì •ë¹„ vs ë³€ë™ë¹„**: ë¹„ìš© êµ¬ì¡°ì˜ íŠ¹ì„±

        ### 4. ìì‚° ìš´ìš© í˜„í™©
        **ìì‚° êµ¬ì„±**: ìœ í˜•ìì‚°, ë¬´í˜•ìì‚°, ê¸ˆìœµìì‚° ë¹„ì¤‘
        **íˆ¬ì íŒ¨í„´**: ì„¤ë¹„íˆ¬ìë‚˜ ì—°êµ¬ê°œë°œ íˆ¬ì ê·œëª¨
        **ìì‚° íš¨ìœ¨ì„±**: ìì‚° ëŒ€ë¹„ ë§¤ì¶œ ì°½ì¶œ ëŠ¥ë ¥

        ### 5. ì‚¬ì—… ëª¨ë¸ íŠ¹ì„±
        **ìˆ˜ìµ ëª¨ë¸**: ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ìˆ˜ìµì„ ì°½ì¶œí•˜ëŠ”ì§€
        **ê²½ìŸ ìš”ì†Œ**: ì¬ë¬´ì œí‘œì—ì„œ ë“œëŸ¬ë‚˜ëŠ” ê²½ìŸë ¥ ìš”ì†Œ
        **ë¦¬ìŠ¤í¬ ìš”ì¸**: ì¬ë¬´êµ¬ì¡°ìƒ ë‚˜íƒ€ë‚˜ëŠ” ìœ„í—˜ ìš”ì†Œ

        ### 6. ì—…ê³„ íŠ¹ì„± ë° ì „ë§
        **ì—…ê³„ ë™í–¥**: í•´ë‹¹ ì—…ì¢…ì˜ ì¼ë°˜ì  íŠ¹ì„±
        **ì„±ì¥ ê°€ëŠ¥ì„±**: ì¬ë¬´ ë°ì´í„°ë¡œ ë³¸ ì„±ì¥ ì ì¬ë ¥
        **íˆ¬ì ë§¤ë ¥ë„**: íˆ¬ìì ê´€ì ì—ì„œì˜ ë§¤ë ¥ë„

        ëª¨ë“  ë¶„ì„ì€ ì¬ë¬´ì œí‘œ ë°ì´í„°ì— ê·¼ê±°í•˜ì—¬ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ì™€ í•¨ê»˜ ì œì‹œí•´ì£¼ì„¸ìš”.
        """
    
    def _build_financial_analysis_prompt(self, company_name: str, financial_data: Dict) -> str:
        """ì¬ë¬´ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return f"""
        ë‹¤ìŒì€ {company_name}ì˜ ì¬ë¬´ì œí‘œ ë°ì´í„°ì…ë‹ˆë‹¤:
        
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¬ë¬´ë¶„ì„ì„ í•´ì£¼ì„¸ìš”:

        ## ğŸ“Š {company_name} ì¬ë¬´ë¶„ì„ ë¦¬í¬íŠ¸

        ### 1. ì¬ë¬´ ê±´ì „ì„± ë¶„ì„
        **ë¶€ì±„ë¹„ìœ¨**: XX% (ê³„ì‚°ì‹ê³¼ ì˜ë¯¸ ì„¤ëª…)
        **ìœ ë™ë¹„ìœ¨**: XX% (ë‹¨ê¸° ì§€ê¸‰ëŠ¥ë ¥)
        **ìê¸°ìë³¸ë¹„ìœ¨**: XX% (ì¬ë¬´ì•ˆì •ì„±)
        **ì´ìë³´ìƒë°°ìˆ˜**: XXë°° (ì´ìì§€ê¸‰ëŠ¥ë ¥)

        ### 2. ìˆ˜ìµì„± ë¶„ì„  
        **ë§¤ì¶œì•¡**: XXì–µì› (ì „ë…„ ëŒ€ë¹„ XX% ì¦ê°)
        **ë§¤ì¶œì´ì´ìµë¥ **: XX% (ì›ê°€ íš¨ìœ¨ì„±)
        **ì˜ì—…ì´ìµë¥ **: XX% (ë³¸ì—… ìˆ˜ìµì„±)
        **ìˆœì´ìµë¥ **: XX% (ìµœì¢… ìˆ˜ìµì„±)
        **ROE**: XX% (ìê¸°ìë³¸ìˆ˜ìµë¥ )
        **ROA**: XX% (ì´ìì‚°ìˆ˜ìµë¥ )

        ### 3. ì„±ì¥ì„± ë¶„ì„
        **ë§¤ì¶œ ì¦ê°€ìœ¨**: XX% (ì„±ì¥ ë™ë ¥)
        **ì˜ì—…ì´ìµ ì¦ê°€ìœ¨**: XX% (ìˆ˜ìµì„± ê°œì„ )
        **ìì‚° ì¦ê°€ìœ¨**: XX% (ì‚¬ì—… í™•ì¥)
        **ì„±ì¥ ì§€ì†ê°€ëŠ¥ì„±**: ì„±ì¥ì˜ ì§ˆì  í‰ê°€

        ### 4. í™œë™ì„± ë¶„ì„
        **ì´ìì‚°íšŒì „ìœ¨**: XXíšŒ (ìì‚° í™œìš© íš¨ìœ¨ì„±)
        **ì¬ê³ ìì‚°íšŒì „ìœ¨**: XXíšŒ (ì¬ê³  ê´€ë¦¬ íš¨ìœ¨ì„±)
        **ë§¤ì¶œì±„ê¶ŒíšŒì „ìœ¨**: XXíšŒ (ì±„ê¶Œ íšŒìˆ˜ íš¨ìœ¨ì„±)

        ### 5. ê°•ì  ë¶„ì„
        **ì£¼ìš” ê°•ì  3ê°€ì§€**
        1. ì²« ë²ˆì§¸ ê°•ì ê³¼ êµ¬ì²´ì  ê·¼ê±°
        2. ë‘ ë²ˆì§¸ ê°•ì ê³¼ êµ¬ì²´ì  ê·¼ê±°  
        3. ì„¸ ë²ˆì§¸ ê°•ì ê³¼ êµ¬ì²´ì  ê·¼ê±°

        ### 6. ì•½ì  ë° ìœ„í—˜ìš”ì¸
        **ì£¼ìš” ì•½ì  3ê°€ì§€**
        1. ì²« ë²ˆì§¸ ì•½ì ê³¼ ê°œì„  í•„ìš”ì‚¬í•­
        2. ë‘ ë²ˆì§¸ ì•½ì ê³¼ ê°œì„  í•„ìš”ì‚¬í•­
        3. ì„¸ ë²ˆì§¸ ì•½ì ê³¼ ê°œì„  í•„ìš”ì‚¬í•­

        ### 7. íˆ¬ì ì˜ê²¬
        **ì¢…í•© ì ìˆ˜**: â­â­â­â­ (5ì  ë§Œì )
        **íˆ¬ì ë“±ê¸‰**: ë§¤ìˆ˜/ë³´ìœ /ë§¤ë„ ë“±ê¸‰ê³¼ ê·¼ê±°
        **ëª©í‘œì£¼ê°€**: ì¬ë¬´ì§€í‘œ ê¸°ë°˜ ì ì • ê°€ì¹˜ í‰ê°€
        **í•µì‹¬ ëª¨ë‹ˆí„°ë§ ì§€í‘œ**: ì§€ì† ê´€ì°°í•´ì•¼ í•  ì¬ë¬´ì§€í‘œ

        ëª¨ë“  ìˆ˜ì¹˜ëŠ” êµ¬ì²´ì ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ì œì‹œí•˜ê³ , ì „ë…„ ëŒ€ë¹„ ë³€í™”ë„ í•¨ê»˜ ë¶„ì„í•´ì£¼ì„¸ìš”.
        """
    
    def _build_audit_prompt(self, company_name: str, financial_data: Dict) -> str:
        """ê°ì‚¬ ìœ ì˜ì‚¬í•­ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return f"""
        ë‹¤ìŒì€ {company_name}ì˜ ì¬ë¬´ì œí‘œ ë°ì´í„°ì…ë‹ˆë‹¤:
        
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        íšŒê³„ê°ì‚¬ ê´€ì ì—ì„œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:

        ## âš ï¸ {company_name} íšŒê³„ê°ì‚¬ ìœ ì˜ì‚¬í•­

        ### 1. ìˆ˜ìµì¸ì‹ ê´€ë ¨ ìœ„í—˜ìš”ì†Œ
        **ìœ„í—˜ë„**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        **ì£¼ìš” ê²€í† ì‚¬í•­**: êµ¬ì²´ì ì¸ ìœ„í—˜ ìš”ì†Œ
        **ê°ì‚¬ì ˆì°¨**: ìˆ˜í–‰í•´ì•¼ í•  êµ¬ì²´ì  ì ˆì°¨
        **ì¤‘ìš”ì„±**: ì™œ ì´ ë¶€ë¶„ì´ ì¤‘ìš”í•œì§€ ì„¤ëª…

        ### 2. ìì‚° ì†ìƒ ë° í‰ê°€ ì´ìŠˆ
        **ìœ„í—˜ë„**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ  
        **ì£¼ìš” ê²€í† ì‚¬í•­**: ì†ìƒ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ìì‚°
        **ê°ì‚¬ì ˆì°¨**: ì†ìƒ í…ŒìŠ¤íŠ¸ ê²€ì¦ ë°©ë²•
        **ì—…ì¢… íŠ¹ì„±**: í•´ë‹¹ ì—…ì¢…ì˜ íŠ¹ìˆ˜ì„±

        ### 3. ë¶€ì±„ ë° ì¶©ë‹¹ê¸ˆ ì ì •ì„±
        **ìœ„í—˜ë„**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        **ì£¼ìš” ê²€í† ì‚¬í•­**: ì¶©ë‹¹ê¸ˆ ì¶”ì •ì˜ í•©ë¦¬ì„±
        **ê°ì‚¬ì ˆì°¨**: ì¶©ë‹¹ê¸ˆ ì‚°ì • ê·¼ê±° ê²€í† 
        **ê³¼ê±° ë³€ë™ì„±**: ì „ë…„ ëŒ€ë¹„ ë³€í™” ë¶„ì„

        ### 4. íŠ¹ìˆ˜ê´€ê³„ì ê±°ë˜
        **ìœ„í—˜ë„**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        **ì£¼ìš” ê²€í† ì‚¬í•­**: ê±°ë˜ì˜ ì™„ì „ì„±ê³¼ ê³µì •ì„±
        **ê°ì‚¬ì ˆì°¨**: íŠ¹ìˆ˜ê´€ê³„ì ê±°ë˜ ê²€ì¦ ë°©ë²•
        **ê³µì‹œ adequacy**: ê³µì‹œì˜ ì¶©ë¶„ì„±

        ### 5. ê³„ì†ê¸°ì—… ê°€ì •
        **ìœ„í—˜ë„**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        **ì£¼ìš” ê²€í† ì‚¬í•­**: ìœ ë™ì„± ë° ìˆ˜ìµì„± ë¶„ì„
        **ê°ì‚¬ì ˆì°¨**: ê³„ì†ê¸°ì—… í‰ê°€ ë°©ë²•
        **ì§€í‘œ ë¶„ì„**: êµ¬ì²´ì  ì¬ë¬´ ì§€í‘œ ê²€í† 

        ### 6. ë‚´ë¶€í†µì œ ì·¨ì•½ì 
        **ìœ„í—˜ë„**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        **ì£¼ìš” ê²€í† ì‚¬í•­**: í†µì œ í™˜ê²½ í‰ê°€
        **ê°ì‚¬ì ˆì°¨**: ë‚´ë¶€í†µì œ í…ŒìŠ¤íŠ¸ ë°©ë²•
        **IT í†µì œ**: ì •ë³´ì‹œìŠ¤í…œ í†µì œ ê²€í† 

        ### 7. ì—…ì¢…ë³„ íŠ¹ìˆ˜ ê°ì‚¬ìœ„í—˜
        **ìœ„í—˜ë„**: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        **ì—…ì¢… íŠ¹ì„±**: í•´ë‹¹ ì—…ì¢… íŠ¹ìˆ˜ ì´ìŠˆ
        **ê°ì‚¬ì ˆì°¨**: ì—…ì¢…ë³„ íŠ¹í™” ê°ì‚¬ ë°©ë²•
        **ê·œì œ í™˜ê²½**: ê´€ë ¨ ë²•ê·œ ë° ê·œì œ ë³€í™”

        ê° í•­ëª©ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•˜ê³ , ì‹¤ë¬´ì—ì„œ ë°”ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
        """
    
    def _build_chat_prompt(self, company_name: str, financial_data: Dict, user_question: str) -> str:
        """ì±—ë´‡ ëŒ€í™”ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return f"""
        ë‹¹ì‹ ì€ {company_name}ì˜ ì¬ë¬´ì œí‘œë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
        
        ## ğŸ“Š íšŒì‚¬ ì¬ë¬´ì •ë³´:
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        ## ğŸ’¬ ì‚¬ìš©ì ì§ˆë¬¸: 
        {user_question}
        
        ## ğŸ“‹ ë‹µë³€ ê°€ì´ë“œë¼ì¸:
        1. ìœ„ ì¬ë¬´ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•˜ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ ì œê³µ
        2. êµ¬ì²´ì ì¸ ìˆ«ìì™€ ê·¼ê±°ë¥¼ í¬í•¨í•˜ì—¬ ì„¤ëª…
        3. ì „ë¬¸ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…
        4. í•„ìš”ì‹œ ì—…ì¢… í‰ê· ì´ë‚˜ ê²½ìŸì‚¬ì™€ ë¹„êµ
        5. íˆ¬ìì ê´€ì ì—ì„œ ì‹¤ìš©ì ì¸ ì¡°ì–¸ í¬í•¨
        
        ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.
        """


class PromptManager:
    """í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ í´ë˜ìŠ¤"""
    
    @staticmethod
    def get_analysis_prompts():
        """ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ë“¤"""
        return {
            'business': 'ì‚¬ì—…ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸',
            'financial': 'ì¬ë¬´ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸',
            'audit': 'ê°ì‚¬ ìœ ì˜ì‚¬í•­ìš© í”„ë¡¬í”„íŠ¸', 
            'chat': 'ì±—ë´‡ ëŒ€í™”ìš© í”„ë¡¬í”„íŠ¸'
        }
    
    @staticmethod
    def customize_prompt(base_prompt: str, **kwargs) -> str:
        """í”„ë¡¬í”„íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì§•"""
        return base_prompt.format(**kwargs)