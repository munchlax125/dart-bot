"""
Gemini AI ì±—ë´‡ ëª¨ë“ˆ
- ì¬ë¬´ ë¶„ì„
- ê°ì‚¬ ìœ ì˜ì‚¬í•­ ë¶„ì„
- ëŒ€í™”í˜• ì±—ë´‡
"""

import google.generativeai as genai
from typing import Dict
import json


class GeminiAnalyzer:
    """Gemini AI ê¸°ë°˜ ì¬ë¬´ ë¶„ì„ê¸°"""
    
    def __init__(self, api_key: str):
        genai.configure(api_key=api_key)
        self.model = genai.GenerativeModel('gemini-1.5-pro')
        
    def simple_analysis(self, company_name: str, financial_data: Dict) -> str:
        """ê°„ë‹¨ ì¬ë¬´ ë¶„ì„"""
        prompt = self._build_simple_analysis_prompt(company_name, financial_data)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def audit_points_analysis(self, company_name: str, financial_data: Dict) -> str:
        """íšŒê³„ê°ì‚¬ ìœ ì˜ì‚¬í•­ ë¶„ì„"""
        prompt = self._build_audit_prompt(company_name, financial_data)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ê°ì‚¬ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def chat_response(self, company_name: str, financial_data: Dict, user_question: str) -> str:
        """ëŒ€í™”í˜• ì±—ë´‡ ì‘ë‹µ"""
        prompt = self._build_chat_prompt(company_name, financial_data, user_question)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def _build_simple_analysis_prompt(self, company_name: str, financial_data: Dict) -> str:
        """ê°„ë‹¨ ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return f"""
        ë‹¤ìŒì€ {company_name}ì˜ ì¬ë¬´ì œí‘œ ë°ì´í„°ì…ë‹ˆë‹¤:
        
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ í•­ëª©ë“¤ì— ëŒ€í•´ ê°„ë‹¨í•˜ê³  ëª…í™•í•œ ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”:
        
        ## ğŸ“Š ì¬ë¬´ ë¶„ì„ ë¦¬í¬íŠ¸
        
        ### 1. ì¬ë¬´ ê±´ì „ì„± â­â­â­â­â­
        - ë¶€ì±„ë¹„ìœ¨, ìœ ë™ë¹„ìœ¨, ìê¸°ìë³¸ë¹„ìœ¨ ë“± ë¶„ì„
        - ì „ë…„ ëŒ€ë¹„ ë³€í™”ì™€ ì—…ì¢… í‰ê·  ëŒ€ë¹„ í‰ê°€
        
        ### 2. ìˆ˜ìµì„± ë¶„ì„ â­â­â­â­â­
        - ë§¤ì¶œì•¡, ì˜ì—…ì´ìµ, ë‹¹ê¸°ìˆœì´ìµ ë³€í™” ë¶„ì„
        - ìˆ˜ìµì„± ì§€í‘œ (ROE, ROA, ì˜ì—…ì´ìµë¥  ë“±) í‰ê°€
        
        ### 3. ì„±ì¥ì„± ë¶„ì„ â­â­â­â­â­
        - ì „ë…„ ëŒ€ë¹„ ì£¼ìš” ì§€í‘œ ë³€í™”ìœ¨
        - ì„±ì¥ ë™ë ¥ê³¼ ì§€ì†ê°€ëŠ¥ì„± í‰ê°€
        
        ### 4. íˆ¬ì í¬ì¸íŠ¸
        **ê°•ì :**
        - êµ¬ì²´ì ì¸ ê°•ì  3ê°€ì§€
        
        **ì•½ì :**  
        - ì£¼ì˜í•´ì•¼ í•  ì•½ì  3ê°€ì§€
        
        ### 5. ì¢…í•© í‰ê°€
        - **ì ìˆ˜**: â­â­â­â­ (5ì  ë§Œì )
        - **í•œì¤„í‰**: "êµ¬ì²´ì ì´ê³  ì§ê´€ì ì¸ í‰ê°€"
        
        ë¶„ì„ì€ ì¼ë°˜ íˆ¬ììê°€ ì´í•´í•˜ê¸° ì‰½ë„ë¡ êµ¬ì²´ì ì¸ ìˆ«ìì™€ ë¹„ìœ¨ì„ í¬í•¨í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”.
        """
    
    def _build_audit_prompt(self, company_name: str, financial_data: Dict) -> str:
        """ê°ì‚¬ ìœ ì˜ì‚¬í•­ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return f"""
        ë‹¤ìŒì€ {company_name}ì˜ ì¬ë¬´ì œí‘œ ë°ì´í„°ì…ë‹ˆë‹¤:
        
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        íšŒê³„ê°ì‚¬ ê´€ì ì—ì„œ ë‹¤ìŒ ì‚¬í•­ë“¤ì„ ê²€í† í•˜ê³  ìœ ì˜ì‚¬í•­ì„ ì œì‹œí•´ì£¼ì„¸ìš”:
        
        ## âš ï¸ íšŒê³„ê°ì‚¬ ìœ ì˜ì‚¬í•­ ì²´í¬ë¦¬ìŠ¤íŠ¸
        
        ### 1. ìˆ˜ìµì¸ì‹ ê´€ë ¨ ìœ„í—˜ìš”ì†Œ
        - ìˆ˜ìµì¸ì‹ ê¸°ì¤€ì˜ ì ì •ì„±
        - ë‹¤ì¤‘ìš”ì†Œê³„ì•½ ìˆ˜ìµë°°ë¶„ ê²€í† ì‚¬í•­
        - ì¥ê¸°ê³„ì•½ ì§„í–‰ë¥  ê²€í†  í¬ì¸íŠ¸
        - **ê°ì‚¬ì ˆì°¨**: êµ¬ì²´ì ì¸ ê°ì‚¬ ë°©ë²• ì œì‹œ
        
        ### 2. ìì‚° ì†ìƒ ë° í‰ê°€ ì´ìŠˆ
        - ìœ í˜•ìì‚° ì†ìƒ ê²€í†  í•„ìš”ì„±
        - ë¬´í˜•ìì‚° ì†ìƒ í…ŒìŠ¤íŠ¸ ì¤‘ìš”ì„±
        - ì¬ê³ ìì‚° ì €ê°€ë²• ì ìš© ê²€í† 
        - **ê°ì‚¬ì ˆì°¨**: ì†ìƒ í…ŒìŠ¤íŠ¸ ê²€ì¦ ë°©ë²•
        
        ### 3. ë¶€ì±„ ë° ì¶©ë‹¹ê¸ˆ ì ì •ì„±
        - ìš°ë°œë¶€ì±„ ì¸ì‹ ê²€í† 
        - ì¶©ë‹¹ê¸ˆ ì¶”ì •ì˜ í•©ë¦¬ì„±
        - ê¸ˆìœµë¶€ì±„ ê³µì •ê°€ì¹˜ í‰ê°€
        - **ê°ì‚¬ì ˆì°¨**: ì¶©ë‹¹ê¸ˆ ì‚°ì • ê·¼ê±° ê²€í† 
        
        ### 4. íŠ¹ìˆ˜ê´€ê³„ì ê±°ë˜
        - íŠ¹ìˆ˜ê´€ê³„ì ê±°ë˜ì˜ ì™„ì „ì„±
        - ê±°ë˜ê°€ê²©ì˜ ê³µì •ì„± ê²€í† 
        - ê³µì‹œì˜ ì¶©ë¶„ì„±
        - **ê°ì‚¬ì ˆì°¨**: íŠ¹ìˆ˜ê´€ê³„ì ê±°ë˜ ê²€ì¦
        
        ### 5. ê³„ì†ê¸°ì—… ê°€ì •
        - ìœ ë™ì„± ìœ„í—˜ í‰ê°€
        - ì˜ì—…í˜„ê¸ˆíë¦„ ë¶„ì„
        - ì°¨ì…ê¸ˆ ìƒí™˜ëŠ¥ë ¥ ê²€í† 
        - **ê°ì‚¬ì ˆì°¨**: ê³„ì†ê¸°ì—… í‰ê°€ ë°©ë²•
        
        ### 6. ë‚´ë¶€í†µì œ ì·¨ì•½ì 
        - ì¬ë¬´ë³´ê³  ë‚´ë¶€í†µì œ í‰ê°€
        - IT í†µì œ í™˜ê²½ ê²€í† 
        - ê²½ì˜ì§„ ê°ì‹œì²´ê³„ í‰ê°€
        - **ê°ì‚¬ì ˆì°¨**: ë‚´ë¶€í†µì œ í…ŒìŠ¤íŠ¸ ë°©ë²•
        
        ### 7. ì—…ì¢…ë³„ íŠ¹ìˆ˜ ê°ì‚¬ìœ„í—˜
        - í•´ë‹¹ ì—…ì¢…ì˜ íŠ¹ìˆ˜í•œ íšŒê³„ ì´ìŠˆ
        - ê·œì œ í™˜ê²½ ë³€í™” ì˜í–¥
        - ê¸°ìˆ  ë³€í™”ì— ë”°ë¥¸ ìœ„í—˜
        - **ê°ì‚¬ì ˆì°¨**: ì—…ì¢…ë³„ íŠ¹í™” ê°ì‚¬ ë°©ë²•
        
        ê° í•­ëª©ë³„ë¡œ êµ¬ì²´ì ì¸ ê°ì‚¬ì ˆì°¨ì™€ ê²€í†  í¬ì¸íŠ¸ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”.
        ê°ì‚¬ì¸ì´ ì‹¤ë¬´ì—ì„œ ë°”ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” ì‹¤ìš©ì ì¸ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
        """
    
    def _build_chat_prompt(self, company_name: str, financial_data: Dict, user_question: str) -> str:
        """ì±—ë´‡ ëŒ€í™”ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return f"""
        ë‹¹ì‹ ì€ {company_name}ì˜ ì¬ë¬´ì œí‘œë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
        
        ## ğŸ“Š íšŒì‚¬ ì¬ë¬´ì •ë³´:
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        ## ğŸ’¬ ì‚¬ìš©ì ì§ˆë¬¸: 
        {user_question}
        
        ## ğŸ“‹ ë‹µë³€ ê°€ì´ë“œë¼ì¸:
        1. ìœ„ ì¬ë¬´ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•˜ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ ì œê³µ
        2. êµ¬ì²´ì ì¸ ìˆ«ìì™€ ê·¼ê±°ë¥¼ í¬í•¨í•˜ì—¬ ì„¤ëª…
        3. ì „ë¬¸ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…
        4. í•„ìš”ì‹œ ì—…ì¢… í‰ê· ì´ë‚˜ ê²½ìŸì‚¬ì™€ ë¹„êµ
        5. íˆ¬ìì ê´€ì ì—ì„œ ì‹¤ìš©ì ì¸ ì¡°ì–¸ í¬í•¨
        
        ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.
        """


class PromptManager:
    """í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ í´ë˜ìŠ¤"""
    
    @staticmethod
    def get_analysis_prompts():
        """ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ë“¤"""
        return {
            'simple': 'ê°„ë‹¨ ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸',
            'audit': 'ê°ì‚¬ ìœ ì˜ì‚¬í•­ìš© í”„ë¡¬í”„íŠ¸', 
            'chat': 'ì±—ë´‡ ëŒ€í™”ìš© í”„ë¡¬í”„íŠ¸'
        }
    
    @staticmethod
    def customize_prompt(base_prompt: str, **kwargs) -> str:
        """í”„ë¡¬í”„íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì§•"""
        return base_prompt.format(**kwargs)
