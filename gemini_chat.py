"""
Gemini AI ì±—ë´‡ ëª¨ë“ˆ
- ì¬ë¬´ ë¶„ì„
- ê°ì‚¬ ìœ ì˜ì‚¬í•­ ë¶„ì„
- ëŒ€í™”í˜• ì±—ë´‡
"""

import google.generativeai as genai
from typing import Dict
import json


class GeminiAnalyzer:
    """Gemini AI ê¸°ë°˜ ì¬ë¬´ ë¶„ì„ê¸°"""
    
    def __init__(self, api_key: str):
        genai.configure(api_key=api_key)
        self.model = genai.GenerativeModel('gemini-1.5-pro')
        
    def simple_analysis(self, company_name: str, financial_data: Dict) -> str:
        """ê°„ë‹¨ ì¬ë¬´ ë¶„ì„"""
        prompt = self._build_simple_analysis_prompt(company_name, financial_data)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def audit_points_analysis(self, company_name: str, financial_data: Dict) -> str:
        """íšŒê³„ê°ì‚¬ ìœ ì˜ì‚¬í•­ ë¶„ì„"""
        prompt = self._build_audit_prompt(company_name, financial_data)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ê°ì‚¬ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def chat_response(self, company_name: str, financial_data: Dict, user_question: str) -> str:
        """ëŒ€í™”í˜• ì±—ë´‡ ì‘ë‹µ"""
        prompt = self._build_chat_prompt(company_name, financial_data, user_question)
        
        try:
            response = self.model.generate_content(prompt)
            return response.text
        except Exception as e:
            return f"ë‹µë³€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    def _build_simple_analysis_prompt(self, company_name: str, financial_data: Dict) -> str:
        """ê°„ë‹¨ ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ ìƒì„± (UI ê°œì„  ë²„ì „)"""
        return f"""
        ë‹¤ìŒì€ {company_name}ì˜ ì¬ë¬´ì œí‘œ ë°ì´í„°ì…ë‹ˆë‹¤:
        
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        ì´ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:

        ## ğŸ“Š {company_name} ì¬ë¬´ ë¶„ì„ ë¦¬í¬íŠ¸

        ### 1. ì¬ë¬´ ê±´ì „ì„±
        ë¶€ì±„ë¹„ìœ¨: XX%
        ìœ ë™ë¹„ìœ¨: XX%
        ìê¸°ìë³¸ë¹„ìœ¨: XX%
        ì „ë…„ ëŒ€ë¹„ ë³€í™”: ê°œì„ /ì•…í™” ë° êµ¬ì²´ì  ìˆ˜ì¹˜

        ### 2. ìˆ˜ìµì„± ë¶„ì„  
        ë§¤ì¶œì•¡: XXì–µì› (ì „ë…„ ëŒ€ë¹„ XX% ì¦ê°)
        ì˜ì—…ì´ìµ: XXì–µì› (ì˜ì—…ì´ìµë¥  XX%)
        ë‹¹ê¸°ìˆœì´ìµ: XXì–µì› (ì „ë…„ ëŒ€ë¹„ XX% ì¦ê°)
        ROE: XX%

        ### 3. ì„±ì¥ì„± ë¶„ì„
        ë§¤ì¶œ ì¦ê°€ìœ¨: XX%
        ì˜ì—…ì´ìµ ì¦ê°€ìœ¨: XX%
        ì´ìì‚° ì¦ê°€ìœ¨: XX%
        ì„±ì¥ ë™ë ¥: êµ¬ì²´ì ì¸ ì„±ì¥ ìš”ì¸ ì„¤ëª…

        ### 4. íˆ¬ì í¬ì¸íŠ¸

        **ê°•ì **
        1. ì²« ë²ˆì§¸ ê°•ì 
        2. ë‘ ë²ˆì§¸ ê°•ì   
        3. ì„¸ ë²ˆì§¸ ê°•ì 

        **ì•½ì **
        1. ì²« ë²ˆì§¸ ì•½ì 
        2. ë‘ ë²ˆì§¸ ì•½ì 
        3. ì„¸ ë²ˆì§¸ ì•½ì 

        ### 5. ì¢…í•© í‰ê°€
        ì ìˆ˜: â­â­â­â­ (5ì  ë§Œì )
        í•œì¤„í‰: "êµ¬ì²´ì ì´ê³  ì§ê´€ì ì¸ í‰ê°€ í•œ ë¬¸ì¥"

        ëª¨ë“  ìˆ˜ì¹˜ëŠ” êµ¬ì²´ì ì¸ ìˆ«ìë¡œ ì œì‹œí•˜ê³ , ê° í•­ëª©ì€ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•´ì£¼ì„¸ìš”.
        ì´íƒ¤ë¦­ì²´ë‚˜ ë³µì¡í•œ ì„œì‹ ëŒ€ì‹  ëª…í™•í•œ êµ¬ë¶„ì„ ìœ„í•´ ì¤„ë°”ê¿ˆì„ í™œìš©í•´ì£¼ì„¸ìš”.
        """
    
    def _build_audit_prompt(self, company_name: str, financial_data: Dict) -> str:
        """ê°ì‚¬ ìœ ì˜ì‚¬í•­ìš© í”„ë¡¬í”„íŠ¸ ìƒì„± (UI ê°œì„  ë²„ì „)"""
        return f"""
        ë‹¤ìŒì€ {company_name}ì˜ ì¬ë¬´ì œí‘œ ë°ì´í„°ì…ë‹ˆë‹¤:
        
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        íšŒê³„ê°ì‚¬ ê´€ì ì—ì„œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”:

        ## âš ï¸ {company_name} íšŒê³„ê°ì‚¬ ìœ ì˜ì‚¬í•­

        ### 1. ìˆ˜ìµì¸ì‹ ê´€ë ¨ ìœ„í—˜ìš”ì†Œ
        ìœ„í—˜ë„: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        ì£¼ìš” ê²€í† ì‚¬í•­: êµ¬ì²´ì ì¸ ìœ„í—˜ ìš”ì†Œ
        ê°ì‚¬ì ˆì°¨: ìˆ˜í–‰í•´ì•¼ í•  êµ¬ì²´ì  ì ˆì°¨
        ì¤‘ìš”ì„±: ì™œ ì´ ë¶€ë¶„ì´ ì¤‘ìš”í•œì§€ ì„¤ëª…

        ### 2. ìì‚° ì†ìƒ ë° í‰ê°€ ì´ìŠˆ
        ìœ„í—˜ë„: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ  
        ì£¼ìš” ê²€í† ì‚¬í•­: ì†ìƒ ê°€ëŠ¥ì„±ì´ ìˆëŠ” ìì‚°
        ê°ì‚¬ì ˆì°¨: ì†ìƒ í…ŒìŠ¤íŠ¸ ê²€ì¦ ë°©ë²•
        ì—…ì¢… íŠ¹ì„±: í•´ë‹¹ ì—…ì¢…ì˜ íŠ¹ìˆ˜ì„±

        ### 3. ë¶€ì±„ ë° ì¶©ë‹¹ê¸ˆ ì ì •ì„±
        ìœ„í—˜ë„: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        ì£¼ìš” ê²€í† ì‚¬í•­: ì¶©ë‹¹ê¸ˆ ì¶”ì •ì˜ í•©ë¦¬ì„±
        ê°ì‚¬ì ˆì°¨: ì¶©ë‹¹ê¸ˆ ì‚°ì • ê·¼ê±° ê²€í† 
        ê³¼ê±° ë³€ë™ì„±: ì „ë…„ ëŒ€ë¹„ ë³€í™” ë¶„ì„

        ### 4. íŠ¹ìˆ˜ê´€ê³„ì ê±°ë˜
        ìœ„í—˜ë„: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        ì£¼ìš” ê²€í† ì‚¬í•­: ê±°ë˜ì˜ ì™„ì „ì„±ê³¼ ê³µì •ì„±
        ê°ì‚¬ì ˆì°¨: íŠ¹ìˆ˜ê´€ê³„ì ê±°ë˜ ê²€ì¦ ë°©ë²•
        ê³µì‹œ adequacy: ê³µì‹œì˜ ì¶©ë¶„ì„±

        ### 5. ê³„ì†ê¸°ì—… ê°€ì •
        ìœ„í—˜ë„: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        ì£¼ìš” ê²€í† ì‚¬í•­: ìœ ë™ì„± ë° ìˆ˜ìµì„± ë¶„ì„
        ê°ì‚¬ì ˆì°¨: ê³„ì†ê¸°ì—… í‰ê°€ ë°©ë²•
        ì§€í‘œ ë¶„ì„: êµ¬ì²´ì  ì¬ë¬´ ì§€í‘œ ê²€í† 

        ### 6. ë‚´ë¶€í†µì œ ì·¨ì•½ì 
        ìœ„í—˜ë„: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        ì£¼ìš” ê²€í† ì‚¬í•­: í†µì œ í™˜ê²½ í‰ê°€
        ê°ì‚¬ì ˆì°¨: ë‚´ë¶€í†µì œ í…ŒìŠ¤íŠ¸ ë°©ë²•
        IT í†µì œ: ì •ë³´ì‹œìŠ¤í…œ í†µì œ ê²€í† 

        ### 7. ì—…ì¢…ë³„ íŠ¹ìˆ˜ ê°ì‚¬ìœ„í—˜
        ìœ„í—˜ë„: ë†’ìŒ/ë³´í†µ/ë‚®ìŒ
        ì—…ì¢… íŠ¹ì„±: í•´ë‹¹ ì—…ì¢… íŠ¹ìˆ˜ ì´ìŠˆ
        ê°ì‚¬ì ˆì°¨: ì—…ì¢…ë³„ íŠ¹í™” ê°ì‚¬ ë°©ë²•
        ê·œì œ í™˜ê²½: ê´€ë ¨ ë²•ê·œ ë° ê·œì œ ë³€í™”

        ê° í•­ëª©ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•˜ê³ , ì‹¤ë¬´ì—ì„œ ë°”ë¡œ í™œìš©í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
        """
    
    def _build_chat_prompt(self, company_name: str, financial_data: Dict, user_question: str) -> str:
        """ì±—ë´‡ ëŒ€í™”ìš© í”„ë¡¬í”„íŠ¸ ìƒì„±"""
        return f"""
        ë‹¹ì‹ ì€ {company_name}ì˜ ì¬ë¬´ì œí‘œë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
        
        ## ğŸ“Š íšŒì‚¬ ì¬ë¬´ì •ë³´:
        {json.dumps(financial_data, ensure_ascii=False, indent=2)}
        
        ## ğŸ’¬ ì‚¬ìš©ì ì§ˆë¬¸: 
        {user_question}
        
        ## ğŸ“‹ ë‹µë³€ ê°€ì´ë“œë¼ì¸:
        1. ìœ„ ì¬ë¬´ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •í™•í•˜ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ ì œê³µ
        2. êµ¬ì²´ì ì¸ ìˆ«ìì™€ ê·¼ê±°ë¥¼ í¬í•¨í•˜ì—¬ ì„¤ëª…
        3. ì „ë¬¸ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…
        4. í•„ìš”ì‹œ ì—…ì¢… í‰ê· ì´ë‚˜ ê²½ìŸì‚¬ì™€ ë¹„êµ
        5. íˆ¬ìì ê´€ì ì—ì„œ ì‹¤ìš©ì ì¸ ì¡°ì–¸ í¬í•¨
        
        ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì¹œì ˆí•˜ê³  ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.
        """


class PromptManager:
    """í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ í´ë˜ìŠ¤"""
    
    @staticmethod
    def get_analysis_prompts():
        """ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ë“¤"""
        return {
            'simple': 'ê°„ë‹¨ ë¶„ì„ìš© í”„ë¡¬í”„íŠ¸',
            'audit': 'ê°ì‚¬ ìœ ì˜ì‚¬í•­ìš© í”„ë¡¬í”„íŠ¸', 
            'chat': 'ì±—ë´‡ ëŒ€í™”ìš© í”„ë¡¬í”„íŠ¸'
        }
    
    @staticmethod
    def customize_prompt(base_prompt: str, **kwargs) -> str:
        """í”„ë¡¬í”„íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì§•"""
        return base_prompt.format(**kwargs)